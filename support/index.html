<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë‹¤ë´‡ 1:1 ë¬¸ì˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            height: 90vh;
            max-height: 800px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #5865F2 0%, #4752C4 100%);
            padding: 25px;
            color: white;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-section {
            display: none;
            padding: 40px;
            justify-content: center;
            align-items: center;
            flex: 1;
        }

        .login-section.active {
            display: flex;
        }

        .discord-login-btn {
            background: #5865F2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
        }

        .discord-login-btn:hover {
            background: #4752C4;
        }

        /* ì±„íŒ… í™”ë©´ */
        .chat-section {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .chat-section.active {
            display: flex;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #f7f7f7;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #5865F2;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .admin-badge {
            background: #e74c3c;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ (ê´€ë¦¬ììš©) */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background: #f0f0f0;
        }

        .chat-item.active {
            background: #e8f0fe;
            border-left: 4px solid #5865F2;
        }

        .chat-item-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #5865F2;
        }

        .chat-item-info {
            flex: 1;
        }

        .chat-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-item-preview {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ë©”ì‹œì§€ ì˜ì—­ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 70%;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.received .message-bubble {
            background: #f0f0f0;
            color: #333;
            border-top-left-radius: 4px;
        }

        .message.sent .message-bubble {
            background: #5865F2;
            color: white;
            border-top-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            padding: 0 8px;
        }

        .message.sent .message-time {
            text-align: right;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            padding: 0 8px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-container {
            padding: 15px 20px;
            background: #f7f7f7;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 15px;
            resize: none;
            font-family: inherit;
            max-height: 120px;
            overflow-y: auto;
        }

        .message-input:focus {
            outline: none;
            border-color: #5865F2;
        }

        .send-btn {
            background: #5865F2;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #4752C4;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #999;
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 14px;
        }

        /* ê´€ë¦¬ì ë ˆì´ì•„ì›ƒ */
        .admin-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .admin-sidebar {
            width: 300px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .admin-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– ë‚˜ë‹¤ë´‡ 1:1 ë¬¸ì˜</h1>
            <p>ì‹¤ì‹œê°„ ì±„íŒ…ìœ¼ë¡œ ë¬¸ì˜í•˜ì„¸ìš”</p>
        </div>

        <div class="content">
            <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
            <div class="login-section active">
                <button class="discord-login-btn" onclick="loginWithDiscord()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Discordë¡œ ë¡œê·¸ì¸
                </button>
            </div>

            <!-- ì¼ë°˜ ì‚¬ìš©ì ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section" id="userChat">
                <div class="user-info">
                    <div class="user-details" id="userDetails"></div>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <div class="messages-container" id="messagesContainer"></div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ê´€ë¦¬ì ì±„íŒ… ì„¹ì…˜ -->
            <div class="chat-section" id="adminChat">
                <div class="user-info">
                    <div class="user-details" id="adminDetails"></div>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <div class="admin-layout">
                    <div class="admin-sidebar">
                        <div class="sidebar-header">ğŸ’¬ ë¬¸ì˜ ëª©ë¡</div>
                        <div class="chat-list" id="chatList">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ’¬</div>
                                <div class="empty-state-text">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                <div class="empty-state-subtext">ì‚¬ìš©ìì˜ ë¬¸ì˜ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
                            </div>
                        </div>
                    </div>

                    <div class="admin-main">
                        <div class="messages-container" id="adminMessagesContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ‘ˆ</div>
                                <div class="empty-state-text">ëŒ€í™”ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                                <div class="empty-state-subtext">ì™¼ìª½ì—ì„œ ë¬¸ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                            </div>
                        </div>

                        <div class="input-container" id="adminInputContainer" style="display: none;">
                            <div class="input-wrapper">
                                <textarea 
                                    class="message-input" 
                                    id="adminMessageInput" 
                                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                    rows="1"
                                    onkeydown="handleAdminKeyDown(event)"
                                ></textarea>
                                <button class="send-btn" onclick="sendAdminMessage()" id="adminSendBtn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ========================================
        // âš™ï¸ ì„¤ì • - ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”!
        // ========================================
        const DISCORD_CLIENT_ID = '1463689452730847262';
        const ADMIN_USERNAME = '._.nada_';

        // Firebase ì„¤ì • (Firebase Consoleì—ì„œ ë°›ì€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDTAiWrCZ5S8Q-9oeecU7UD64PRWYoNHaE",
            authDomain: "nadabot-cc983.firebaseapp.com",
            databaseURL: "https://nadabot-cc983-default-rtdb.firebaseio.com",
            projectId: "nadabot-cc983",
            storageBucket: "nadabot-cc983.appspot.com",
            messagingSenderId: "1088503354703",
            appId: "1:1088503354703:web:e9db8f8f4b22346589213a"
        };
        // ========================================

        let currentUser = null;
        let selectedChatUserId = null;
        let messageListeners = [];

        // Firebase ì´ˆê¸°í™”
        if (FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') {
            firebase.initializeApp(FIREBASE_CONFIG);
        }

        // í˜ì´ì§€ ë¡œë“œ
        window.onload = function() {
            handleOAuthCallback();
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showChatSection();
            }
        };

        // Discord ë¡œê·¸ì¸
        function loginWithDiscord() {
            const redirectUri = 'https://nadabot.kro.kr/support';
            const params = new URLSearchParams({
                client_id: DISCORD_CLIENT_ID,
                redirect_uri: redirectUri,
                response_type: 'token',
                scope: 'identify'
            });
            window.location.href = `https://discord.com/api/oauth2/authorize?${params.toString()}`;
        }

        // OAuth ì½œë°± ì²˜ë¦¬
        function handleOAuthCallback() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');

            if (accessToken) {
                fetchUserInfo(accessToken);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!response.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                const userData = await response.json();
                currentUser = {
                    id: userData.id,
                    username: userData.username,
                    discriminator: userData.discriminator || '0',
                    avatar: userData.avatar 
                        ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`
                        : `https://cdn.discordapp.com/embed/avatars/${parseInt(userData.discriminator) % 5}.png`,
                    isAdmin: userData.username === ADMIN_USERNAME
                };

                localStorage.setItem('user', JSON.stringify(currentUser));
                showChatSection();
            } catch (error) {
                alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì±„íŒ… ì„¹ì…˜ í‘œì‹œ
        function showChatSection() {
            document.querySelector('.login-section').classList.remove('active');

            if (FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') {
                alert('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. README íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (currentUser.isAdmin) {
                showAdminChat();
            } else {
                showUserChat();
            }
        }

        // ì¼ë°˜ ì‚¬ìš©ì ì±„íŒ…
        function showUserChat() {
            document.getElementById('userChat').classList.add('active');
            
            document.getElementById('userDetails').innerHTML = `
                <img src="${currentUser.avatar}" class="user-avatar">
                <div>
                    <div class="user-name">${currentUser.username}</div>
                    <div style="font-size: 12px; color: #666;">ë‚˜ë‹¤ë´‡ ê³ ê°ì§€ì›</div>
                </div>
            `;

            loadUserMessages();
        }

        // ê´€ë¦¬ì ì±„íŒ…
        function showAdminChat() {
            document.getElementById('adminChat').classList.add('active');
            
            document.getElementById('adminDetails').innerHTML = `
                <img src="${currentUser.avatar}" class="user-avatar">
                <div>
                    <div class="user-name">${currentUser.username}<span class="admin-badge">ADMIN</span></div>
                    <div style="font-size: 12px; color: #666;">ê´€ë¦¬ì ëª¨ë“œ</div>
                </div>
            `;

            loadChatList();
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ë¡œë“œ
        function loadUserMessages() {
            const messagesRef = firebase.database().ref(`chats/${currentUser.id}/messages`);
            
            messagesRef.on('value', (snapshot) => {
                const messages = [];
                snapshot.forEach((child) => {
                    messages.push({ id: child.key, ...child.val() });
                });
                
                messages.sort((a, b) => a.timestamp - b.timestamp);
                displayMessages(messages, 'messagesContainer');
            });
        }

        // ê´€ë¦¬ì: ì±„íŒ… ëª©ë¡ ë¡œë“œ
        function loadChatList() {
            const chatsRef = firebase.database().ref('chats');
            
            chatsRef.on('value', (snapshot) => {
                const chatList = document.getElementById('chatList');
                const chats = [];

                snapshot.forEach((child) => {
                    const chatData = child.val();
                    if (child.key !== 'admin') {
                        chats.push({
                            userId: child.key,
                            userInfo: chatData.userInfo,
                            lastMessage: chatData.lastMessage,
                            timestamp: chatData.lastMessage?.timestamp || 0
                        });
                    }
                });

                if (chats.length === 0) {
                    chatList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div class="empty-state-text">ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="empty-state-subtext">ì‚¬ìš©ìì˜ ë¬¸ì˜ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
                        </div>
                    `;
                    return;
                }

                chats.sort((a, b) => b.timestamp - a.timestamp);

                chatList.innerHTML = chats.map(chat => `
                    <div class="chat-item ${selectedChatUserId === chat.userId ? 'active' : ''}" 
                         onclick="selectChat('${chat.userId}')">
                        <img src="${chat.userInfo.avatar}" class="chat-item-avatar">
                        <div class="chat-item-info">
                            <div class="chat-item-name">${chat.userInfo.username}</div>
                            <div class="chat-item-preview">${chat.lastMessage?.text || 'ìƒˆ ëŒ€í™”'}</div>
                        </div>
                    </div>
                `).join('');
            });
        }

        // ê´€ë¦¬ì: ì±„íŒ… ì„ íƒ
        function selectChat(userId) {
            messageListeners.forEach(listener => listener.off());
            messageListeners = [];

            selectedChatUserId = userId;
            
            const messagesRef = firebase.database().ref(`chats/${userId}/messages`);
            const listener = messagesRef.on('value', (snapshot) => {
                const messages = [];
                snapshot.forEach((child) => {
                    messages.push({ id: child.key, ...child.val() });
                });
                
                messages.sort((a, b) => a.timestamp - b.timestamp);
                displayMessages(messages, 'adminMessagesContainer');
            });

            messageListeners.push(messagesRef);
            document.getElementById('adminInputContainer').style.display = 'block';
            loadChatList();
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function displayMessages(messages, containerId) {
            const container = document.getElementById(containerId);
            
            if (messages.length === 0 && containerId === 'messagesContainer') {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <div class="empty-state-text">ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
                        <div class="empty-state-subtext">ì²« ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = currentUser.isAdmin 
                    ? msg.senderId === 'admin' 
                    : msg.senderId === currentUser.id;
                
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <img src="${msg.senderAvatar}" class="message-avatar">
                        <div class="message-content">
                            ${!isSent ? `<div class="message-sender">${msg.senderName}</div>` : ''}
                            <div class="message-bubble">${escapeHtml(msg.text)}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // ì¼ë°˜ ì‚¬ìš©ì: ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            const messageData = {
                text: text,
                senderId: currentUser.id,
                senderName: currentUser.username,
                senderAvatar: currentUser.avatar,
                timestamp: Date.now()
            };

            try {
                await firebase.database().ref(`chats/${currentUser.id}/messages`).push(messageData);
                
                await firebase.database().ref(`chats/${currentUser.id}`).update({
                    userInfo: {
                        username: currentUser.username,
                        avatar: currentUser.avatar,
                        id: currentUser.id
                    },
                    lastMessage: {
                        text: text,
                        timestamp: Date.now()
                    }
                });

                input.value = '';
                input.style.height = 'auto';
            } catch (error) {
                alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ê´€ë¦¬ì: ë©”ì‹œì§€ ì „ì†¡
        async function sendAdminMessage() {
            if (!selectedChatUserId) return;

            const input = document.getElementById('adminMessageInput');
            const text = input.value.trim();
            
            if (!text) return;

            const messageData = {
                text: text,
                senderId: 'admin',
                senderName: currentUser.username,
                senderAvatar: currentUser.avatar,
                timestamp: Date.now()
            };

            try {
                await firebase.database().ref(`chats/${selectedChatUserId}/messages`).push(messageData);
                
                await firebase.database().ref(`chats/${selectedChatUserId}/lastMessage`).set({
                    text: text,
                    timestamp: Date.now()
                });

                input.value = '';
                input.style.height = 'auto';
            } catch (error) {
                alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleAdminKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminMessage();
            }
        }

        function logout() {
            messageListeners.forEach(listener => listener.off());
            localStorage.removeItem('user');
            location.reload();
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
            if (diff < 86400000) return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const textareas = document.querySelectorAll('.message-input');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            });
        });
    </script>
</body>
</html>
